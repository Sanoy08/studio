/**
 * This ruleset enforces a security model for the 'eShop Revitalize' e-commerce application.
 *
 * Core Philosophy:
 * The security model is hybrid. User-specific data (profiles, orders, carts) is governed
 * by a strict user-ownership principle, where only the data owner or an administrator
 * can access or modify it. Publicly consumed data, such as products, is readable by anyone
 * but writable only by administrators.
 *
 * Data Structure:
 * - /users/{userId}: Contains private user profiles.
 * - /users/{userId}/orders/{orderId}: User's order history.
 * - /users/{userId}/carts/{cartId}: User's shopping cart.
 * - /products/{productId}: A top-level collection for all product listings.
 * - /roles_admin/{userId}: A top-level collection used as an admin role lookup table.
 *
 * Key Security Decisions:
 * - Admin Access: A user is considered an administrator if a document with their UID
 *   exists in the /roles_admin collection. This is a highly performant and secure
 *   method for role-based access control that avoids costly document reads.
 * - User Privacy: Listing documents in the top-level /users collection is disallowed
 *   to prevent user enumeration.
 * - Denormalization for Authorization: User-centric documents (like Orders and Carts)
 *   contain a denormalized 'userId' field. This avoids slow and costly `get()` calls in
 *   rules, making authorization checks faster and simpler.
 * - Path-Based Security: All data nested under /users/{userId} is inherently protected
 *   by rules that verify ownership against the `userId` in the path.
 *
 * Structural Segregation:
 * The separation of private data (/users) from public-read data (/products) is a key
 * architectural choice. This makes security rules for list operations simple, secure,
 * and efficient, as it avoids filtering collections based on document fields.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * Checks if the currently authenticated user has admin privileges.
     * Admin status is granted by the existence of a document in the /roles_admin collection.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Checks if a document exists for update/delete operations.
     */
    function isExistingDoc() {
      return getAfter(resource).data != null;
    }

    /**
     * Validates that the user is the owner or an admin for an existing document.
     * Used for safe update and delete operations on user-owned content.
     */
    function isExistingOwnerOrAdmin(userId) {
      return isExistingDoc() && (isOwner(userId) || isAdmin());
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow A user (auth.uid='user123') creates their own profile (create) at /users/user123.
     * @deny An anonymous user tries to read any user profile.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false; // Disallow listing all users for privacy
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwnerOrAdmin(userId);
      allow delete: if isExistingOwnerOrAdmin(userId);
    }

    /**
     * @description Controls access to product listings, which are public to read.
     * @path /products/{productId}
     * @allow Any user, authenticated or not, can view a product's details (get, list).
     * @deny A non-admin user attempts to create a new product.
     * @principle Enforces a public-read, admin-only write access pattern.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isExistingDoc() && isAdmin();
      allow delete: if isExistingDoc() && isAdmin();
    }

    /**
     * @description Controls access to a user's orders.
     * @path /users/{userId}/orders/{orderId}
     * @allow A user (auth.uid='user123') lists their own orders (list) from /users/user123/orders.
     * @deny A user (auth.uid='user456') tries to read an order from /users/user123/orders/{orderId}.
     * @principle Enforces document ownership and validates relational integrity.
     */
    match /users/{userId}/orders/{orderId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId) || isAdmin();
      allow create: if (isOwner(userId) || isAdmin()) && request.resource.data.userId == userId;
      allow update: if isExistingOwnerOrAdmin(userId);
      allow delete: if isExistingOwnerOrAdmin(userId);
    }

    /**
     * @description Controls access to a user's shopping cart.
     * @path /users/{userId}/carts/{cartId}
     * @allow A user (auth.uid='user123') updates their own cart (update) at /users/user123/carts/{cartId}.
     * @deny A user (auth.uid='user456') tries to delete the cart of another user.
     * @principle Enforces document ownership and validates relational integrity.
     */
    match /users/{userId}/carts/{cartId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId) || isAdmin();
      allow create: if (isOwner(userId) || isAdmin()) && request.resource.data.userId == userId;
      allow update: if isExistingOwnerOrAdmin(userId);
      allow delete: if isExistingOwnerOrAdmin(userId);
    }

    /**
     * @description Controls access to items within a user's shopping cart.
     * @path /users/{userId}/carts/{cartId}/cartItems/{cartItemId}
     * @allow A user (auth.uid='user123') adds an item (create) to their own cart.
     * @deny A user (auth.uid='user456') tries to list items from another user's cart.
     * @principle Enforces inherited ownership from parent path and validates relational integrity.
     */
    match /users/{userId}/carts/{cartId}/cartItems/{cartItemId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId) || isAdmin();
      allow create: if (isOwner(userId) || isAdmin()) && request.resource.data.cartId == cartId;
      allow update: if isExistingOwnerOrAdmin(userId);
      allow delete: if isExistingOwnerOrAdmin(userId);
    }

    /**
     * @description Controls access to the admin roles collection.
     * @path /roles_admin/{userId}
     * @allow An existing admin grants another user admin access (create).
     * @deny Any non-admin user attempts to read, list, or write to this collection.
     * @principle Secures the role-management collection to be readable only by rules and writable only by admins.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if false; // Disallow listing admins to prevent enumeration
      allow create: if isAdmin();
      allow update: if isExistingDoc() && isAdmin();
      allow delete: if isExistingDoc() && isAdmin();
    }
  }
}