{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user in the e-commerce system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "firstName": {
          "type": "string",
          "description": "User's first name."
        },
        "lastName": {
          "type": "string",
          "description": "User's last name."
        },
        "isAdmin": {
          "type": "boolean",
          "description": "Indicates if the user is an administrator."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the user was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp of when the user was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "email",
        "firstName",
        "lastName",
        "isAdmin",
        "createdAt",
        "updatedAt"
      ]
    },
    "Product": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Product",
      "type": "object",
      "description": "Represents a product in the e-commerce system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the product."
        },
        "name": {
          "type": "string",
          "description": "Name of the product."
        },
        "description": {
          "type": "string",
          "description": "Description of the product."
        },
        "price": {
          "type": "number",
          "description": "Price of the product."
        },
        "imageUrl": {
          "type": "string",
          "description": "URL of the product image.",
          "format": "uri"
        },
        "category": {
          "type": "string",
          "description": "Category of the product."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the product was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp of when the product was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "price",
        "imageUrl",
        "category",
        "createdAt",
        "updatedAt"
      ]
    },
    "Order": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Order",
      "type": "object",
      "description": "Represents an order placed by a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the order."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Order)"
        },
        "orderDate": {
          "type": "string",
          "description": "Date the order was placed.",
          "format": "date-time"
        },
        "totalAmount": {
          "type": "number",
          "description": "Total amount of the order."
        },
        "status": {
          "type": "string",
          "description": "Status of the order (e.g., pending, processing, completed)."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the order was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp of when the order was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "orderDate",
        "totalAmount",
        "status",
        "createdAt",
        "updatedAt"
      ]
    },
    "OrderItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "OrderItem",
      "type": "object",
      "description": "Represents an item within an order.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the order item."
        },
        "orderId": {
          "type": "string",
          "description": "Reference to Order. (Relationship: Order 1:N OrderItem)"
        },
        "productId": {
          "type": "string",
          "description": "Reference to Product. (Relationship: Product 1:N OrderItem)"
        },
        "quantity": {
          "type": "number",
          "description": "Quantity of the product in the order item."
        },
        "itemPrice": {
          "type": "number",
          "description": "Price of the item at the time of the order."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the orderItem was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp of when the orderItem was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "orderId",
        "productId",
        "quantity",
        "itemPrice",
        "createdAt",
        "updatedAt"
      ]
    },
    "Cart": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Cart",
      "type": "object",
      "description": "Represents a shopping cart for a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the cart."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:1 Cart)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the cart was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp of when the cart was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "createdAt",
        "updatedAt"
      ]
    },
    "CartItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CartItem",
      "type": "object",
      "description": "Represents an item within a shopping cart.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the cart item."
        },
        "cartId": {
          "type": "string",
          "description": "Reference to Cart. (Relationship: Cart 1:N CartItem)"
        },
        "productId": {
          "type": "string",
          "description": "Reference to Product. (Relationship: Product 1:N CartItem)"
        },
        "quantity": {
          "type": "number",
          "description": "Quantity of the product in the cart item."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the cartItem was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp of when the cartItem was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "cartId",
        "productId",
        "quantity",
        "createdAt",
        "updatedAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles. Only the user (or admin) can access. Admin status checked via /roles_admin/{userId}.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/products/{productId}",
        "definition": {
          "entityName": "Product",
          "schema": {
            "$ref": "#/backend/entities/Product"
          },
          "description": "Stores product details. Read access is generally public, but write access is restricted to admins.",
          "params": [
            {
              "name": "productId",
              "description": "The unique identifier of the product."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/orders/{orderId}",
        "definition": {
          "entityName": "Order",
          "schema": {
            "$ref": "#/backend/entities/Order"
          },
          "description": "Stores order information for a specific user.  Includes denormalized 'userId' field for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "orderId",
              "description": "The unique identifier of the order."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/carts/{cartId}",
        "definition": {
          "entityName": "Cart",
          "schema": {
            "$ref": "#/backend/entities/Cart"
          },
          "description": "Stores the shopping cart for a specific user.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "cartId",
              "description": "The unique identifier of the cart."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/carts/{cartId}/cartItems/{cartItemId}",
        "definition": {
          "entityName": "CartItem",
          "schema": {
            "$ref": "#/backend/entities/CartItem"
          },
          "description": "Stores items within a user's shopping cart. Includes denormalized 'cartId' and 'userId' fields for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "cartId",
              "description": "The unique identifier of the cart."
            },
            {
              "name": "cartItemId",
              "description": "The unique identifier of the cart item."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "roles_admin",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Indicates admin privileges for a user. Existence of the document grants admin access.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the e-commerce application, 'eShop Revitalize', focusing on scalability, security, and ease of debugging. The structure emphasizes authorization independence by denormalizing authorization-related data, avoiding `get()` calls in security rules. This approach allows for atomic operations (transactions/batches) and simplifies debugging. Homogeneous security postures are maintained by ensuring all documents within a collection share the same security requirements, separating public and private data into distinct collections. Access is modeled consistently using path-based ownership and membership maps where applicable. The structure also explicitly models state using a dedicated `status` field where appropriate, and adheres to strict naming conventions to ensure clarity and predictability.\n\n*   `/users/{userId}`: Stores user profiles. Path-based ownership ensures only the user or an admin can access this data.\n*   `/products/{productId}`: Stores product details. All products are generally accessible for reading, but only admins can create, update, or delete them.\n*   `/orders/{orderId}`: Stores order information. Orders are owned by users, so they are placed under the `/users/{userId}/orders/{orderId}` subcollection, ensuring path-based ownership. The userId is denormalized into the order document itself to avoid using `get()` in security rules.\n*   `/users/{userId}/carts/{cartId}`: Each user has one cart. Follows path-based ownership.\n*   `/users/{userId}/carts/{cartId}/cartItems/{cartItemId}`: Cart items belonging to a cart. The cartId and userId are denormalized into the cartItem document to maintain authorization independence.\n*   `/roles_admin/{userId}`: Indicates admin privileges. Existence of a document grants admin access, simplifying admin role checks in security rules.\n\n**Authorization Independence**: Achieved primarily by denormalizing authorization-related data. For example, in the `orders` subcollection under `/users/{userId}`, the `userId` is duplicated within each order document. This eliminates the need to perform `get()` operations in security rules to verify ownership, supporting atomic operations and simplifying rules.\n\n**QAPs (Rules are not Filters)**: Supported via structural segregation and membership models:\n    *   Private User Data: `/users/{userId}` ensures only the specific user can access their data.\n    *   Admin Roles: `/roles_admin/{userId}` allows straightforward checking of admin privileges without needing complex data filtering within rules."
  }
}